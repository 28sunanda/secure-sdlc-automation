# =============================================================================
# ENTERPRISE SECURITY PIPELINE - DevSecOps Automation
# =============================================================================
# This pipeline implements comprehensive security scanning across the SDLC:
# - Secret Detection (Gitleaks)
# - SAST (Semgrep, Bandit)
# - SCA (Safety, pip-audit, Snyk)
# - Container Security (Hadolint, Trivy)
# - IaC Security (Checkov)
# - DAST (OWASP ZAP)
# - Compliance Validation (OWASP ASVS, NIST 800-53)
# =============================================================================

name: üõ°Ô∏è Enterprise Security Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - sast-only
          - sca-only
          - container-only
          - dast-only

# Cancel in-progress runs for the same branch
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  SCAN_OUTPUT_DIR: 'security-reports'

jobs:
  # ==========================================================================
  # SECRET DETECTION
  # ==========================================================================
  secret-detection:
    name: üîë Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
        continue-on-error: true

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
        continue-on-error: true

  # ==========================================================================
  # SAST - Static Application Security Testing
  # ==========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/python
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep.sarif
          retention-days: 30

  sast-bandit:
    name: üêç SAST - Bandit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit bandit-sarif-formatter

      - name: Run Bandit
        run: |
          bandit -r app/ -f sarif -o bandit-results.sarif --severity-level medium || true
        continue-on-error: true

      - name: Upload Bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-results.sarif
        continue-on-error: true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-results
          path: bandit-results.sarif
          retention-days: 30

  # ==========================================================================
  # SCA - Software Composition Analysis
  # ==========================================================================
  sca-dependency-scan:
    name: üì¶ SCA - Dependency Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install safety pip-audit cyclonedx-bom

      - name: Run Safety check
        run: |
          safety check -r requirements.txt --json > safety-results.json || true
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip-audit -r requirements.txt -f json -o pip-audit-results.json || true
        continue-on-error: true

      - name: Generate SBOM
        run: |
          cyclonedx-py requirements -i requirements.txt -o sbom.json --format json || true
        continue-on-error: true

      - name: Upload SCA results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sca-results
          path: |
            safety-results.json
            pip-audit-results.json
            sbom.json
          retention-days: 30

  sca-snyk:
    name: üîê SCA - Snyk
    runs-on: ubuntu-latest
    if: vars.ENABLE_SNYK == 'true'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk-results.sarif

      - name: Upload Snyk SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-results.sarif
        continue-on-error: true

  # ==========================================================================
  # CONTAINER SECURITY
  # ==========================================================================
  container-security:
    name: üê≥ Container Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: infrastructure/docker/Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
        continue-on-error: true

      - name: Upload Hadolint SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif
        continue-on-error: true

      - name: Build Docker image
        run: |
          docker build -t secure-app:${{ github.sha }} -f infrastructure/docker/Dockerfile .
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'secure-app:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

      - name: Upload Container Security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-results
          path: |
            hadolint-results.sarif
            trivy-results.sarif
          retention-days: 30

  # ==========================================================================
  # IaC SECURITY
  # ==========================================================================
  iac-security:
    name: üèóÔ∏è IaC Security - Checkov
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure/terraform
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

      - name: Upload Checkov results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-results
          path: checkov-results.sarif
          retention-days: 30

  # ==========================================================================
  # DAST - Dynamic Application Security Testing (OWASP ZAP)
  # ==========================================================================
  dast-zap-scan:
    name: üåê DAST - OWASP ZAP
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for target to be ready
        run: |
          echo "üîç Checking if target is accessible..."
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://secure-flask-api.onrender.com/health || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Target is ready! (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "‚è≥ Waiting for target to wake up (attempt $i/5, HTTP $HTTP_CODE)..."
            sleep 30
          done
          echo "‚ö†Ô∏è Target may be slow, proceeding anyway..."

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'https://secure-flask-api.onrender.com'
          rules_file_name: '.zap-rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          fail_action: false
          artifact_name: 'zap-dast-report'

      - name: Upload ZAP HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report-html
          path: report_html.html
          retention-days: 30

      - name: Upload ZAP Markdown Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report-md
          path: report_md.md
          retention-days: 30

      - name: Upload ZAP JSON Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report-json
          path: report_json.json
          retention-days: 30

  # ==========================================================================
  # COMPLIANCE VALIDATION
  # ==========================================================================
  compliance-check:
    name: üìã Compliance Validation
    runs-on: ubuntu-latest
    needs: [sast-semgrep, sast-bandit, sca-dependency-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate OWASP ASVS mapping
        run: |
          echo "üìã Validating OWASP ASVS compliance mapping..."
          if [ -f "security/compliance/owasp-asvs-mapping.yml" ]; then
            echo "‚úÖ OWASP ASVS mapping file found"
            cat security/compliance/owasp-asvs-mapping.yml | head -50
          else
            echo "‚ö†Ô∏è OWASP ASVS mapping file not found"
          fi

      - name: Validate NIST 800-53 mapping
        run: |
          echo "üìã Validating NIST 800-53 compliance mapping..."
          if [ -f "security/compliance/nist-800-53-mapping.yml" ]; then
            echo "‚úÖ NIST 800-53 mapping file found"
            cat security/compliance/nist-800-53-mapping.yml | head -50
          else
            echo "‚ö†Ô∏è NIST 800-53 mapping file not found"
          fi

  # ==========================================================================
  # SECURITY GATE
  # ==========================================================================
  security-gate:
    name: üö¶ Security Gate
    runs-on: ubuntu-latest
    needs: [secret-detection, sast-semgrep, sast-bandit, sca-dependency-scan, container-security, iac-security, dast-zap-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports
        continue-on-error: true

      - name: Evaluate Security Gate
        run: |
          echo "üö¶ Evaluating Security Gate..."
          echo ""
          echo "Job Results:"
          echo "  - Secret Detection: ${{ needs.secret-detection.result }}"
          echo "  - SAST Semgrep: ${{ needs.sast-semgrep.result }}"
          echo "  - SAST Bandit: ${{ needs.sast-bandit.result }}"
          echo "  - SCA Dependency: ${{ needs.sca-dependency-scan.result }}"
          echo "  - Container Security: ${{ needs.container-security.result }}"
          echo "  - IaC Security: ${{ needs.iac-security.result }}"
          echo "  - DAST ZAP: ${{ needs.dast-zap-scan.result }}"
          echo ""
          
          # Count failures
          FAILURES=0
          for result in "${{ needs.secret-detection.result }}" "${{ needs.sast-semgrep.result }}" "${{ needs.sast-bandit.result }}" "${{ needs.sca-dependency-scan.result }}" "${{ needs.container-security.result }}" "${{ needs.iac-security.result }}" "${{ needs.dast-zap-scan.result }}"; do
            if [ "$result" = "failure" ]; then
              FAILURES=$((FAILURES + 1))
            fi
          done
          
          echo "Total job failures: $FAILURES"
          
          if [ $FAILURES -gt 2 ]; then
            echo "‚ùå Security Gate FAILED - Too many job failures"
            exit 1
          else
            echo "‚úÖ Security Gate PASSED"
          fi

      - name: Generate Security Summary
        if: always()
        run: |
          echo "## üõ°Ô∏è Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîë Secret Detection | ${{ needs.secret-detection.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîç SAST - Semgrep | ${{ needs.sast-semgrep.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üêç SAST - Bandit | ${{ needs.sast-bandit.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ SCA - Dependencies | ${{ needs.sca-dependency-scan.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üê≥ Container Security | ${{ needs.container-security.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è IaC Security | ${{ needs.iac-security.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üåê DAST - OWASP ZAP | ${{ needs.dast-zap-scan.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä View detailed results in the [Security Tab](/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # NOTIFICATIONS
  # ==========================================================================
  notify-slack:
    name: üì¢ Slack Notification
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: always() && vars.ENABLE_SLACK_NOTIFICATIONS == 'true'
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Security Pipeline Result: ${{ needs.security-gate.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üõ°Ô∏è Security Pipeline Results"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ needs.security-gate.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true
